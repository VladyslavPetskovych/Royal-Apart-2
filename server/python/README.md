# Система машинного навчання для аналізу цін

## Опис

Ця система аналізує ціни за день у тарифі (`tarifPrice.csv`) та знаходить схожі бронювання у реальних даних (`realPrice.csv`), щоб передбачити чи ціна нормальна, висока чи низька.

## Встановлення

```bash
pip install -r requirements.txt
```

## Використання

### 1. Навчання моделей

```bash
python train_and_features.py
```

або

```bash
python app.py
```

Це створить моделі в папці `models/`:

- `price_normality_model.pkl` - модель класифікації (нормальна/висока/низька)
- `price_prediction_model.pkl` - модель передбачення ціни
- `scaler.pkl` - нормалізатор даних

### 2. Передбачення ціни

```bash
python predict_api.py "Кімната 23" "01/09/2024" 3000
```

Або через Python:

```python
from app import predict_price_normality

result = predict_price_normality(
    room="Кімната 23",
    date="01/09/2024",
    price_tarif=3000
)
print(result)
```

## Результат передбачення

```json
{
  "room": "Кімната 23",
  "date": "01/09/2024",
  "price_tarif": 2000.0,
  "predicted_price": 2950.5,
  "status": "Низька",
  "status_code": 0,
  "confidence": {
    "low": 85.2,
    "normal": 10.5,
    "high": 4.3
  },
  "similar_bookings_count": 15,
  "avg_similar_price": 2980.0,
  "median_similar_price": 2500.0,
  "optimal_price": 2500.0,
  "lost_revenue": 500.0,
  "lost_revenue_pct": 20.0,
  "price_range": {
    "min": 2000.0,
    "max": 3500.0
  },
  "warning": "⚠️ Втрачено 500.0 грн (20.0%)"
}
```

### Пояснення полів:

- **price_tarif** - ціна встановлена менеджером у тарифі
- **optimal_price** - оптимальна ціна (медіана реальних цін схожих бронювань)
- **lost_revenue** - втрачені кошти якщо тарифна ціна нижча за оптимальну
- **lost_revenue_pct** - відсоток втрачених коштів
- **median_similar_price** - медіана цін схожих бронювань (більш стійка до викидів)
- **avg_similar_price** - середня ціна схожих бронювань
- **warning** - попередження про втрачені кошти (якщо є)

## Як працює система

1. **Аналіз тарифів**: Читає ціни за день з `tarifPrice.csv`

2. **Пошук схожих бронювань**: Знаходить схожі бронювання у `realPrice.csv` за:

   - Кімнатою (назва кімнати, точний або частковий збіг)
   - Датою (±30 днів для кращого покриття)
   - Якщо не знайдено - шукає всі бронювання цієї кімнати

3. **Розрахунок оптимальної ціни**:

   - Використовує **медіану** реальних цін (більш стійка до викидів)
   - Якщо тарифна ціна нижча за оптимальну - розраховує втрачені кошти

4. **Створення ознак**:

   - День тижня, місяць, день місяця
   - Ціна тарифу
   - Статистика схожих бронювань (середня, медіана, мін, макс, стандартне відхилення)
   - Кількість схожих бронювань
   - Відстань до найближчого бронювання

5. **Передбачення**:
   - Класифікація: чи ціна нормальна (1), висока (2) чи низька (0)
   - Регресія: передбачення очікуваної ціни
   - Розрахунок втрачених коштів та оптимальної ціни

## Критерії оцінки ціни

- **Нормальна**: ±15% від реальної/середньої схожої ціни
- **Низька**: < -15% від реальної/середньої схожої ціни
- **Висока**: > +15% від реальної/середньої схожої ціни
